<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…è¡Œè§„åˆ’åŠ©æ‰‹ - å‰ç«¯æµ‹è¯•è¡¨å•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        h1 {
            color: #1A5490;
            margin-bottom: 24px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 .icon {
            background: rgba(26, 84, 144, 0.1);
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .required::after {
            content: " *";
            color: #e53935;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="email"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #1A5490;
        }

        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #e0e0e0;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .chip:hover {
            border-color: #1A5490;
        }

        .chip.selected {
            background: #1A5490;
            color: white;
            border-color: #1A5490;
        }

        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .budget-info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .budget-breakdown {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .budget-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .budget-item .amount {
            font-weight: 600;
            color: #1565c0;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        button {
            padding: 16px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1A5490;
            color: white;
        }

        .btn-primary:hover {
            background: #0d3a66;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #bdbdbd;
        }

        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            grid-column: span 2;
        }

        .btn-ai:hover {
            opacity: 0.9;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1A5490;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e53935;
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }

        .error.visible {
            display: block;
        }

        .progress-steps {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
            display: none;
        }

        .progress-steps.active {
            display: block;
        }

        .progress-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            gap: 12px;
        }

        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: #e0e0e0;
        }

        .step-icon.done {
            background: #4caf50;
            color: white;
        }

        .step-icon.current {
            background: #1A5490;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .step-text {
            flex: 1;
        }

        .success-message {
            background: #c8e6c9;
            border: 1px solid #81c784;
            color: #2e7d32;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        .success-message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <div class="icon">ğŸ—ºï¸</div>
            <span>æ–°å»ºè¡Œç¨‹</span>
        </h1>

        <form id="tripForm">
            <!-- ç›®çš„åœ° -->
            <div class="form-group">
                <label for="destinations" class="required">ç›®çš„åœ°</label>
                <input
                    type="text"
                    id="destinations"
                    name="destinations"
                    placeholder="ä¾‹å¦‚ï¼šæˆéƒ½ã€é‡åº†ï¼ˆç”¨é¡¿å·åˆ†éš”ï¼‰"
                    required
                >
            </div>

            <!-- æ—¥æœŸé€‰æ‹© -->
            <div class="form-group">
                <label class="required">æ—…è¡Œæ—¥æœŸ</label>
                <div class="date-inputs">
                    <input
                        type="date"
                        id="startDate"
                        name="startDate"
                        required
                    >
                    <input
                        type="date"
                        id="endDate"
                        name="endDate"
                        required
                    >
                </div>
                <div id="dateError" class="error">ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ</div>
            </div>

            <!-- æ—…è¡Œäººæ•° -->
            <div class="form-group">
                <label for="travelers" class="required">æ—…è¡Œäººæ•°</label>
                <input
                    type="number"
                    id="travelers"
                    name="travelers"
                    min="1"
                    max="20"
                    value="2"
                    required
                >
            </div>

            <!-- æ€»é¢„ç®— -->
            <div class="form-group">
                <label for="budgetTotal" class="required">æ€»é¢„ç®—ï¼ˆå…ƒï¼‰</label>
                <input
                    type="number"
                    id="budgetTotal"
                    name="budgetTotal"
                    min="0"
                    step="100"
                    value="5000"
                    required
                >
            </div>

            <!-- é¢„ç®—åˆ†é…é¢„è§ˆ -->
            <div class="budget-info" id="budgetPreview">
                <strong>é¢„ç®—åˆ†é…é¢„è§ˆï¼š</strong>
                <div class="budget-breakdown">
                    <div class="budget-item">
                        <span>ğŸš— äº¤é€š (30%)</span>
                        <span class="amount">Â¥1500</span>
                    </div>
                    <div class="budget-item">
                        <span>ğŸ¨ ä½å®¿ (35%)</span>
                        <span class="amount">Â¥1750</span>
                    </div>
                    <div class="budget-item">
                        <span>ğŸœ é¤é¥® (20%)</span>
                        <span class="amount">Â¥1000</span>
                    </div>
                    <div class="budget-item">
                        <span>ğŸ« æ´»åŠ¨ (15%)</span>
                        <span class="amount">Â¥750</span>
                    </div>
                </div>
            </div>

            <!-- ç¾é£Ÿåå¥½ -->
            <div class="form-group">
                <label>ç¾é£Ÿåå¥½ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="chip-group" id="foodTypes">
                    <span class="chip" data-value="å·èœ">å·èœ</span>
                    <span class="chip" data-value="ç²¤èœ">ç²¤èœ</span>
                    <span class="chip" data-value="æ¹˜èœ">æ¹˜èœ</span>
                    <span class="chip" data-value="ä¸œåŒ—èœ">ä¸œåŒ—èœ</span>
                    <span class="chip" data-value="è¥¿é¤">è¥¿é¤</span>
                    <span class="chip" data-value="æ—¥æ–™">æ—¥æ–™</span>
                    <span class="chip" data-value="éŸ©æ–™">éŸ©æ–™</span>
                    <span class="chip" data-value="æ³°å›½èœ">æ³°å›½èœ</span>
                    <span class="chip" data-value="ç´ é£Ÿ">ç´ é£Ÿ</span>
                    <span class="chip" data-value="å°åƒ">å°åƒ</span>
                </div>
            </div>

            <!-- æ™¯ç‚¹åå¥½ -->
            <div class="form-group">
                <label>æ™¯ç‚¹åå¥½ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div class="chip-group" id="attractionTypes">
                    <span class="chip" data-value="è‡ªç„¶é£å…‰">è‡ªç„¶é£å…‰</span>
                    <span class="chip" data-value="å†å²å¤è¿¹">å†å²å¤è¿¹</span>
                    <span class="chip" data-value="ä¸»é¢˜å…¬å›­">ä¸»é¢˜å…¬å›­</span>
                    <span class="chip" data-value="åšç‰©é¦†">åšç‰©é¦†</span>
                    <span class="chip" data-value="æµ·æ»©">æµ·æ»©</span>
                    <span class="chip" data-value="å±±åŒº">å±±åŒº</span>
                    <span class="chip" data-value="åŸå¸‚è§‚å…‰">åŸå¸‚è§‚å…‰</span>
                    <span class="chip" data-value="æ°‘ä¿—é£æƒ…">æ°‘ä¿—é£æƒ…</span>
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="button-group">
                <button type="submit" class="btn-secondary" id="btnSubmit">åˆ›å»ºè¡Œç¨‹</button>
                <button type="button" class="btn-secondary" id="btnClear">æ¸…ç©º</button>
                <button type="button" class="btn-ai" id="btnAIPlan">âœ¨ AIæ™ºèƒ½è§„åˆ’</button>
            </div>
        </form>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†...</p>
        </div>

        <!-- AIè§„åˆ’è¿›åº¦ -->
        <div class="progress-steps" id="progressSteps"></div>

        <!-- æˆåŠŸæ¶ˆæ¯ -->
        <div class="success-message" id="successMessage">
            <strong>âœ… è¡Œç¨‹åˆ›å»ºæˆåŠŸï¼</strong>
            <p id="tripDetails"></p>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            selectedFoodTypes: [],
            selectedAttractionTypes: [],
            token: null
        };

        // APIé…ç½®
        const API_BASE_URL = 'http://localhost:8000';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setupChipSelection();
            setupFormHandlers();
            updateBudgetPreview();
        });

        // è®¾ç½®chipé€‰æ‹©
        function setupChipSelection() {
            // ç¾é£Ÿç±»å‹
            document.querySelectorAll('#foodTypes .chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const value = chip.dataset.value;
                    if (state.selectedFoodTypes.includes(value)) {
                        state.selectedFoodTypes = state.selectedFoodTypes.filter(t => t !== value);
                        chip.classList.remove('selected');
                    } else {
                        state.selectedFoodTypes.push(value);
                        chip.classList.add('selected');
                    }
                });
            });

            // æ™¯ç‚¹ç±»å‹
            document.querySelectorAll('#attractionTypes .chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const value = chip.dataset.value;
                    if (state.selectedAttractionTypes.includes(value)) {
                        state.selectedAttractionTypes = state.selectedAttractionTypes.filter(t => t !== value);
                        chip.classList.remove('selected');
                    } else {
                        state.selectedAttractionTypes.push(value);
                        chip.classList.add('selected');
                    }
                });
            });
        }

        // è®¾ç½®è¡¨å•å¤„ç†
        function setupFormHandlers() {
            const budgetInput = document.getElementById('budgetTotal');
            budgetInput.addEventListener('input', updateBudgetPreview);

            // æ—¥æœŸéªŒè¯
            document.getElementById('startDate').addEventListener('change', validateDates);
            document.getElementById('endDate').addEventListener('change', validateDates);

            // æŒ‰é’®äº‹ä»¶
            document.getElementById('btnClear').addEventListener('click', clearForm);
            document.getElementById('btnSubmit').addEventListener('click', handleSubmit);
            document.getElementById('btnAIPlan').addEventListener('click', handleAIPlan);
        }

        // æ›´æ–°é¢„ç®—é¢„è§ˆ
        function updateBudgetPreview() {
            const total = parseInt(document.getElementById('budgetTotal').value) || 5000;

            document.querySelectorAll('.budget-item .amount').forEach((el, idx) => {
                const percentages = [0.30, 0.35, 0.20, 0.15];
                el.textContent = 'Â¥' + Math.round(total * percentages[idx]);
            });
        }

        // æ—¥æœŸéªŒè¯
        function validateDates() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            const errorEl = document.getElementById('dateError');

            if (startDate && endDate && endDate <= startDate) {
                errorEl.classList.add('visible');
                return false;
            } else {
                errorEl.classList.remove('visible');
                return true;
            }
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('tripForm').reset();
            state.selectedFoodTypes = [];
            state.selectedAttractionTypes = [];
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('selected'));
            document.getElementById('successMessage').classList.remove('visible');
            document.getElementById('progressSteps').classList.remove('active');
            updateBudgetPreview();
        }

        // è·å–token
        async function loginAndGetToken() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test_user_automation@example.com',
                        password: 'test123456'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    state.token = data.access_token;
                    return true;
                }

                // ç™»å½•å¤±è´¥ï¼Œå°è¯•æ³¨å†Œ
                const registerResponse = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'test_user_automation@example.com',
                        password: 'test123456',
                        nickname: 'è‡ªåŠ¨åŒ–æµ‹è¯•ç”¨æˆ·'
                    })
                });

                if (registerResponse.ok) {
                    const data = await registerResponse.json();
                    state.token = data.access_token;
                    return true;
                }

                return false;
            } catch (error) {
                console.error('è®¤è¯å¤±è´¥:', error);
                return false;
            }
        }

        // æäº¤è¡¨å•ï¼ˆæ‰‹åŠ¨åˆ›å»ºï¼‰
        async function handleSubmit(e) {
            e.preventDefault();

            if (!validateDates()) return;

            showLoading(true);

            if (!await loginAndGetToken()) {
                alert('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                showLoading(false);
                return;
            }

            const formData = getFormData();
            
            try {
                const response = await fetch(`${API_BASE_URL}/trips`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showSuccess(data.trip);
                    clearForm();
                } else {
                    alert('åˆ›å»ºè¡Œç¨‹å¤±è´¥: ' + response.statusText);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            }

            showLoading(false);
        }

        // AIè§„åˆ’
        async function handleAIPlan() {
            if (!validateDates()) return;

            showLoading(true);
            document.getElementById('progressSteps').classList.add('active');

            if (!await loginAndGetToken()) {
                alert('è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
                showLoading(false);
                return;
            }

            const formData = getFormData();
            
            try {
                const response = await fetch(`${API_BASE_URL}/trips/ai-plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = JSON.parse(line.slice(6));
                                addProgressStep(data);

                                if (data.action === 'complete' && data.trip) {
                                    showSuccess(data.trip);
                                    clearForm();
                                    document.getElementById('progressSteps').classList.remove('active');
                                }
                            }
                        }
                    }
                } else {
                    alert('AIè§„åˆ’å¤±è´¥: ' + response.statusText);
                    document.getElementById('progressSteps').classList.remove('active');
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
                document.getElementById('progressSteps').classList.remove('active');
            }

            showLoading(false);
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            const destinations = document.getElementById('destinations').value;
            const budgetTotal = parseInt(document.getElementById('budgetTotal').value) || 5000;

            return {
                title: destinations.split('ã€').filter(d => d.trim()).join('ã€') || 'æœªå‘½åè¡Œç¨‹',
                destinations: destinations.split('ã€').map(d => d.trim()).filter(d => d),
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                travelers: parseInt(document.getElementById('travelers').value) || 2,
                budget: {
                    total: budgetTotal,
                    transport: Math.round(budgetTotal * 0.30),
                    accommodation: Math.round(budgetTotal * 0.35),
                    food: Math.round(budgetTotal * 0.20),
                    activities: Math.round(budgetTotal * 0.15)
                },
                preferences: {
                    foodTypes: state.selectedFoodTypes,
                    attractionTypes: state.selectedAttractionTypes
                }
            };
        }

        // æ·»åŠ è¿›åº¦æ­¥éª¤
        function addProgressStep(data) {
            const container = document.getElementById('progressSteps');
            const step = document.createElement('div');
            step.className = 'progress-step';
            
            const iconClass = data.action === 'complete' ? 'done' :
                           data.progress === 100 ? 'done' : 'current';
            
            step.innerHTML = `
                <div class="step-icon ${iconClass}">
                    ${data.action === 'complete' ? 'âœ“' : data.progress}
                </div>
                <div class="step-text">
                    <strong>${data.message}</strong>
                    ${data.agent ? `<br><small>æ™ºèƒ½ä½“: ${data.agent}</small>` : ''}
                </div>
            `;
            
            container.appendChild(step);
            container.scrollTop = container.scrollHeight;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(trip) {
            const successEl = document.getElementById('successMessage');
            const detailsEl = document.getElementById('tripDetails');
            
            detailsEl.innerHTML = `
                <strong>æ ‡é¢˜:</strong> ${trip.title}<br>
                <strong>ç›®çš„åœ°:</strong> ${Array.isArray(trip.destinations) ? trip.destinations.join(', ') : trip.destinations}<br>
                <strong>æ—¥æœŸ:</strong> ${trip.start_date || trip.startDate} è‡³ ${trip.end_date || trip.endDate}<br>
                <strong>é¢„ç®—:</strong> Â¥${trip.budget?.total || trip.budget || 0}<br>
                <strong>çŠ¶æ€:</strong> ${trip.status || 'å·²åˆ›å»º'}
            `;
            
            successEl.classList.add('visible');
        }
    </script>
</body>
</html>
